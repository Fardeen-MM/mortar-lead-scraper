<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mortar Signal Engine</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .signals-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    .signals-header h2 { margin-bottom: 0; }

    .signal-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .signal-controls .search-input { flex: 1; }

    .signal-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      background: white;
      transition: border-color 0.15s, box-shadow 0.15s;
      animation: fadeIn 0.3s ease;
    }
    .signal-card:hover {
      border-color: var(--indigo-light);
      box-shadow: var(--shadow);
    }

    .signal-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.4rem;
    }

    .signal-firm {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .signal-date {
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .signal-title {
      font-size: 0.9rem;
      color: var(--indigo);
      font-weight: 500;
      margin-bottom: 0.35rem;
    }
    .signal-title a {
      color: inherit;
      text-decoration: none;
    }
    .signal-title a:hover { text-decoration: underline; }

    .signal-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .signal-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.5rem;
      background: var(--cream);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .load-more-wrap {
      text-align: center;
      margin-top: 1rem;
    }

    .scan-btn {
      position: relative;
    }
    .scan-btn.scanning {
      pointer-events: none;
      opacity: 0.7;
    }
    .scan-btn.scanning::after {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 16px; height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .new-badge {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      background: #ecfdf5;
      color: var(--success);
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.5rem;
      text-transform: uppercase;
    }

    .signal-description {
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.5;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #f3f4f6;
    }

    .country-flag {
      font-size: 0.85rem;
    }

    .signal-filter {
      min-width: 100px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">ðŸ§±</span>
        <span class="logo-text">Mortar</span>
      </div>
      <p class="subtitle">Signal Engine</p>
    </header>

    <nav class="header-nav" style="margin-bottom: 0.5rem;">
      <a href="/" class="nav-pill">&larr; Lead Scraper</a>
      <a href="/leads.html" class="nav-pill">Lead Database &rarr;</a>
    </nav>

    <!-- Stats -->
    <div class="stats-bar" id="stats-bar">
      <div class="stat">
        <span class="stat-value" id="stat-total">-</span>
        <span class="stat-label">Total Signals</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="stat-today">-</span>
        <span class="stat-label">Today</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="stat-week">-</span>
        <span class="stat-label">This Week</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="stat-firms">-</span>
        <span class="stat-label">Unique Firms</span>
      </div>
    </div>

    <!-- Controls -->
    <div class="panel active">
      <div class="signals-header">
        <h2>Hiring Signals</h2>
        <button class="btn btn-primary scan-btn" id="scan-btn" onclick="runScan()">Scan Now</button>
      </div>
      <p class="hint" style="margin-bottom:0;">Law firms hiring marketing, intake, and business development roles â€” detected from Indeed.</p>
    </div>

    <!-- Search + Filter -->
    <div class="signal-controls">
      <input type="text" class="search-input" id="search-input" placeholder="Search firms, titles, cities...">
      <select id="filter-country" class="signal-filter">
        <option value="">All Countries</option>
        <option value="US">US</option>
        <option value="UK">UK</option>
        <option value="CA">Canada</option>
        <option value="AU">Australia</option>
      </select>
      <select id="filter-state" class="signal-filter">
        <option value="">All States</option>
      </select>
      <span class="result-count" id="result-count"></span>
    </div>

    <!-- Signal Feed -->
    <div id="signal-feed"></div>

    <!-- Load More -->
    <div class="load-more-wrap" id="load-more-wrap" style="display:none;">
      <button class="btn btn-secondary" onclick="loadMore()">Load More</button>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state" style="display:none;">
      <span class="empty-state-icon">ðŸ“¡</span>
      <h3>No signals yet</h3>
      <p>Click "Scan Now" to search Indeed for law firms hiring marketing, intake, and BD roles.</p>
    </div>
  </div>

  <script>
    let allSignals = [];
    let displayedCount = 0;
    const PAGE_SIZE = 50;
    let searchTimeout = null;

    // Format date as relative time or date
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + (String(dateStr).includes('Z') ? '' : 'Z'));
      if (isNaN(d.getTime())) return '';
      const now = new Date();
      const diffMs = now - d;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function isToday(dateStr) {
      if (!dateStr) return false;
      const d = new Date(dateStr + (String(dateStr).includes('Z') ? '' : 'Z'));
      if (isNaN(d.getTime())) return false;
      return d.toDateString() === new Date().toDateString();
    }

    function isThisWeek(dateStr) {
      if (!dateStr) return false;
      const d = new Date(dateStr + (String(dateStr).includes('Z') ? '' : 'Z'));
      if (isNaN(d.getTime())) return false;
      return d >= new Date(Date.now() - 7 * 86400000);
    }

    const COUNTRY_FLAGS = { US: 'ðŸ‡ºðŸ‡¸', UK: 'ðŸ‡¬ðŸ‡§', CA: 'ðŸ‡¨ðŸ‡¦', AU: 'ðŸ‡¦ðŸ‡º' };

    function renderSignal(signal) {
      const card = document.createElement('div');
      card.className = 'signal-card';

      const location = [signal.city, signal.state].filter(Boolean).join(', ') || 'Unknown';
      const isNew = isToday(signal.detected_at);
      const flag = COUNTRY_FLAGS[signal.country] || '';
      const desc = signal.description ? signal.description.trim() : '';

      const url = safeUrl(signal.job_url);
      card.innerHTML = `
        <div class="signal-top">
          <div class="signal-firm">${flag ? `<span class="country-flag">${flag}</span> ` : ''}${esc(signal.firm_name)}${isNew ? '<span class="new-badge">new</span>' : ''}</div>
          <div class="signal-date">${formatDate(signal.detected_at)}</div>
        </div>
        <div class="signal-title">
          ${url
            ? `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(signal.job_title)} &rarr;</a>`
            : esc(signal.job_title)}
        </div>
        <div class="signal-meta">
          <span class="signal-tag">${esc(location)}</span>
          <span class="signal-tag">${esc(signal.country || 'US')}</span>
          <span class="signal-tag">${esc(signal.source || 'indeed')}</span>
        </div>
        ${desc ? `<div class="signal-description">${esc(desc)}</div>` : ''}
      `;
      return card;
    }

    function esc(str) {
      if (!str && str !== 0) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function safeUrl(url) {
      if (!url) return '';
      try { const u = new URL(url); return (u.protocol === 'http:' || u.protocol === 'https:') ? url : ''; }
      catch { return ''; }
    }

    function getFilteredSignals() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      const stateFilter = document.getElementById('filter-state').value;
      const countryFilter = document.getElementById('filter-country').value;

      return allSignals.filter(s => {
        if (countryFilter && s.country !== countryFilter) return false;
        if (stateFilter && s.state !== stateFilter) return false;
        if (query) {
          const hay = [s.firm_name, s.job_title, s.city, s.state, s.description].join(' ').toLowerCase();
          return hay.includes(query);
        }
        return true;
      });
    }

    function renderFeed() {
      const feed = document.getElementById('signal-feed');
      if (!feed) return;
      const filtered = getFilteredSignals();

      feed.innerHTML = '';
      displayedCount = Math.min(PAGE_SIZE, filtered.length);

      for (let i = 0; i < displayedCount; i++) {
        feed.appendChild(renderSignal(filtered[i]));
      }

      const countEl = document.getElementById('result-count');
      if (countEl) countEl.textContent = `${filtered.length} signal${filtered.length !== 1 ? 's' : ''}`;
      const loadMoreEl = document.getElementById('load-more-wrap');
      if (loadMoreEl) loadMoreEl.style.display = displayedCount < filtered.length ? '' : 'none';
      // Show empty state if no signals at all, or "no results" if filters have no matches
      const emptyEl = document.getElementById('empty-state');
      if (emptyEl) {
        const h3 = emptyEl.querySelector('h3');
        const p = emptyEl.querySelector('p');
        if (allSignals.length === 0) {
          emptyEl.style.display = '';
          if (h3) h3.textContent = 'No signals yet';
          if (p) p.textContent = 'Click "Scan Now" to search Indeed for law firms hiring marketing, intake, and BD roles.';
        } else if (filtered.length === 0) {
          emptyEl.style.display = '';
          if (h3) h3.textContent = 'No matching signals';
          if (p) p.textContent = 'Try adjusting your search or filters.';
        } else {
          emptyEl.style.display = 'none';
        }
      }
    }

    function loadMore() {
      const feed = document.getElementById('signal-feed');
      const filtered = getFilteredSignals();
      const nextBatch = Math.min(displayedCount + PAGE_SIZE, filtered.length);

      for (let i = displayedCount; i < nextBatch; i++) {
        feed.appendChild(renderSignal(filtered[i]));
      }

      displayedCount = nextBatch;
      document.getElementById('load-more-wrap').style.display = displayedCount < filtered.length ? '' : 'none';
    }

    function updateStats() {
      const total = allSignals.length;
      const today = allSignals.filter(s => isToday(s.detected_at)).length;
      const week = allSignals.filter(s => isThisWeek(s.detected_at)).length;
      const firms = new Set(allSignals.map(s => s.firm_name)).size;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-today').textContent = today;
      document.getElementById('stat-week').textContent = week;
      document.getElementById('stat-firms').textContent = firms;
    }

    function populateStateFilter() {
      const select = document.getElementById('filter-state');
      const countryFilter = document.getElementById('filter-country').value;
      const filtered = countryFilter
        ? allSignals.filter(s => s.country === countryFilter)
        : allSignals;
      const states = [...new Set(filtered.map(s => s.state).filter(Boolean))].sort();
      const current = select.value;
      select.innerHTML = '<option value="">All States</option>';
      states.forEach(st => {
        const opt = document.createElement('option');
        opt.value = st;
        opt.textContent = st;
        select.appendChild(opt);
      });
      // Restore selection if still valid, otherwise reset to "All"
      select.value = states.includes(current) ? current : '';
    }

    function showToast(msg, type) {
      let toast = document.getElementById('signal-toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'signal-toast';
        toast.style.cssText = 'position:fixed;bottom:1.5rem;right:1.5rem;padding:0.6rem 1.2rem;border-radius:8px;font-size:0.85rem;z-index:999;opacity:0;transition:opacity 0.3s;max-width:360px;';
        document.body.appendChild(toast);
      }
      toast.style.background = type === 'error' ? '#fef2f2' : '#ecfdf5';
      toast.style.color = type === 'error' ? '#dc2626' : '#059669';
      toast.style.border = `1px solid ${type === 'error' ? '#fecaca' : '#a7f3d0'}`;
      toast.textContent = msg;
      toast.style.opacity = '1';
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => { toast.style.opacity = '0'; }, 4000);
    }

    async function loadSignals() {
      try {
        const res = await fetch('/api/signals?limit=1000');
        if (!res.ok) throw new Error(`Server error (${res.status})`);
        const data = await res.json();
        allSignals = data.signals || [];
        updateStats();
        populateStateFilter();
        renderFeed();
      } catch (err) {
        console.error('Failed to load signals:', err);
        showToast('Failed to load signals: ' + err.message, 'error');
      }
    }

    let _scanRunning = false;

    async function runScan() {
      if (_scanRunning) return;
      _scanRunning = true;
      const btn = document.getElementById('scan-btn');
      btn.classList.add('scanning');
      btn.textContent = 'Scanning...';

      try {
        const res = await fetch('/api/signals/scan', { method: 'POST' });
        if (!res.ok) throw new Error(`Server error (${res.status})`);
        const data = await res.json();

        if (data.status === 'already_running') {
          btn.textContent = 'Already running...';
        }

        // Poll for completion (even if already_running â€” we still want to track it)
        pollScanStatus(btn);
      } catch (err) {
        btn.textContent = 'Error';
        btn.classList.remove('scanning');
        _scanRunning = false;
        showToast('Scan failed: ' + err.message, 'error');
        setTimeout(() => { btn.textContent = 'Scan Now'; }, 3000);
        console.error('Scan failed:', err);
      }
    }

    function pollScanStatus(btn) {
      const startCount = allSignals.length;
      const maxPollTime = 30 * 60 * 1000; // 30 minute timeout
      const startTime = Date.now();
      if (_activePollInterval) clearInterval(_activePollInterval);
      const interval = setInterval(async () => {
        // Timeout protection
        if (Date.now() - startTime > maxPollTime) {
          clearInterval(interval);
          _activePollInterval = null;
          btn.textContent = 'Timed out';
          btn.classList.remove('scanning');
          _scanRunning = false;
          showToast('Scan timed out after 30 minutes', 'error');
          setTimeout(() => { btn.textContent = 'Scan Now'; }, 3000);
          return;
        }
        try {
          const res = await fetch('/api/signals/scan-status');
          if (!res.ok) throw new Error(`Status check failed (${res.status})`);
          const data = await res.json();

          // Refresh signals list while scanning
          await loadSignals();
          const newCount = allSignals.length - startCount;
          btn.textContent = `Scanning... (${newCount} new)`;

          if (!data.running) {
            clearInterval(interval);
            _activePollInterval = null;
            await loadSignals();
            const finalNew = allSignals.length - startCount;
            btn.textContent = `Done! ${finalNew} new`;
            btn.classList.remove('scanning');
            _scanRunning = false;
            if (finalNew > 0) showToast(`Found ${finalNew} new signal${finalNew !== 1 ? 's' : ''}!`, 'success');
            setTimeout(() => { btn.textContent = 'Scan Now'; }, 3000);
          }
        } catch (err) {
          clearInterval(interval);
          _activePollInterval = null;
          btn.textContent = 'Scan Now';
          btn.classList.remove('scanning');
          _scanRunning = false;
          showToast('Polling error: ' + err.message, 'error');
        }
      }, 5000);
      _activePollInterval = interval;
    }

    // Track active poll interval for cleanup
    let _activePollInterval = null;

    // Event listeners
    document.getElementById('search-input').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(renderFeed, 200);
    });

    // Use flag to prevent double render when country change triggers populateStateFilter
    let _skipStateRender = false;
    document.getElementById('filter-state').addEventListener('change', () => {
      if (_skipStateRender) return;
      renderFeed();
    });
    document.getElementById('filter-country').addEventListener('change', () => {
      _skipStateRender = true;
      populateStateFilter();
      _skipStateRender = false;
      renderFeed();
    });

    // Cleanup intervals on page unload
    window.addEventListener('beforeunload', () => {
      if (_activePollInterval) clearInterval(_activePollInterval);
      clearTimeout(searchTimeout);
    });

    // Initial load
    loadSignals();
  </script>
</body>
</html>
